@echo off
setlocal EnableExtensions EnableDelayedExpansion

PUSHD "%~dp0"

set INVOKE_AI_VERSION=main
set arg=%1
if "%arg%" neq "" (
   if "%arg:~0,2%" eq "/?" (
       echo Usage: update.bat ^<release name^>.zip
       echo Updates InvokeAI to use the indicated version of the code base.
       echo Find the version or branch for the release you want, and pass it as the argument.
       echo For example update.sh v2.2.5
       echo.
       echo If no argument provided then will install the most recent development version, equivalent to
       echo 'update.bat main'
       exit /b
   ) else (
       set INVOKE_AI_SRC="https://github.com/invoke-ai/InvokeAI/archive/%arg%.zip"
       set INVOKE_AI_DEP=https://raw.githubusercontent.com/invoke-ai/InvokeAI/%arg%/environments-and-requirements/requirements-base.txt
   )
)

call curl -I "%INVOKE_AI_DEP%" -fs
if %errorlevel% neq 0 (
    echo '%INVOKE_AI_VERSION%' is not a known branch name or tag. Please check the version and try again.
    echo "Press any key to continue"
    pause
    exit /b
)

echo This script will update InvokeAI and all its dependencies to !INVOKE_AI_SRC!.
echo If you do not want to do this, press control-C now!
pause

call curl -L "%INVOKE_AI_DEP%" > environments-and-requirements/requirements-base.txt

call .venv\Scripts\activate.bat
call .venv\Scripts\python -mpip install -r requirements.txt
if %errorlevel% neq 0 (
   echo Installation of requirements failed. See https://invoke-ai.github.io/InvokeAI/installation/INSTALL_AUTOMATED/#troubleshooting for suggestions.
   pause
   exit /b
)

call .venv\Scripts\python -mpip install !INVOKE_AI_SRC!
if %errorlevel% neq 0 (
   echo Installation of InvokeAI failed. See https://invoke-ai.github.io/InvokeAI/installation/INSTALL_AUTOMATED/#troubleshooting for suggestions.
   pause
   exit /b
)

#call .venv\Scripts\python .venv\Scripts\configure_invokeai.py --root=.
#
#if %errorlevel% neq 0 (
#   echo Configuration InvokeAI failed. See https://invoke-ai.github.io/InvokeAI/installation/INSTALL_AUTOMATED/#troubleshooting for suggestions.
#   pause
#   exit /b
#)

echo InvokeAI has been updated to '%INVOKE_AI_VERSION%'

echo "Press any key to continue"
pause
endlocal

